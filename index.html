<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>On Boarding Program</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Confetti for celebration -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- LINE LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        // กำหนดธีมสี Wuerth (โทนสีแดง)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        wuerth: {
                            red: '#CC0000',
                            dark: '#A30000',
                            gray: '#F5F5F5',
                            text: '#333333'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #F8F9FA;
            font-family: 'Sarabun', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        .stamp-appear {
            animation: stampIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes stampIn {
            0% { transform: scale(3) rotate(-30deg); opacity: 0; }
            50% { transform: scale(0.9) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #CC0000;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 16px;
        }

        .stamp-slot {
            aspect-ratio: 1 / 1;
            border-radius: 50%;
            border: 2px dashed #CBD5E1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: white;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
        }

        .stamp-active {
            border: none;
            background-color: #fff0f0;
            box-shadow: 0 4px 6px rgba(204, 0, 0, 0.15);
        }

        .stamp-icon {
            color: #CC0000;
            font-size: 1.5rem;
            opacity: 0;
            transform: scale(0);
        }
    </style>
</head>
<body class="text-wuerth-text h-screen flex flex-col relative overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="absolute inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="loader mb-4"></div>
        <p class="text-wuerth-red font-semibold animate-pulse mt-4" id="loadingText">กำลังโหลดข้อมูล...</p>
    </div>

    <!-- Header Section -->
    <header class="bg-wuerth-red text-white p-4 shadow-md rounded-b-3xl relative z-10">
        <div class="flex items-center justify-between">
            <h1 class="text-xl font-bold tracking-wide">On Boarding Program</h1>
            <i class="fa-solid fa-award text-2xl text-yellow-300"></i>
        </div>
    </header>

    <!-- Main Content (Scrollable) -->
    <main class="flex-1 overflow-y-auto pb-24 px-4 pt-6">
        
        <!-- User Profile Card -->
        <div class="bg-white rounded-2xl shadow-sm p-4 mb-6 flex items-center space-x-4 border border-gray-100">
            <div class="w-16 h-16 rounded-full overflow-hidden border-2 border-wuerth-red shadow-sm bg-gray-200">
                <img id="userProfilePic" src="https://via.placeholder.com/150" alt="Profile" class="w-full h-full object-cover">
            </div>
            <div class="flex-1">
                <h2 id="userName" class="font-bold text-lg text-gray-800">ผู้ใช้งาน</h2>
                <div class="flex items-center text-sm text-gray-500 mt-1">
                    <span class="bg-red-100 text-wuerth-red px-2 py-0.5 rounded-full font-semibold mr-2">
                        <i class="fa-solid fa-star text-xs mr-1"></i> <span id="pointsText">0</span> / 16
                    </span>
                    <span>แต้มสะสม</span>
                </div>
            </div>
        </div>

        <!-- Reward Card Section -->
        <div class="bg-white rounded-3xl shadow-lg border border-gray-200 overflow-hidden relative">
            <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-3 text-center border-b border-gray-200">
                <h3 class="font-bold text-gray-700">สะสมครบ 16 แต้มเพื่อรับรางวัล!</h3>
            </div>
            
            <div class="stamp-grid" id="stampGrid">
                <!-- Javascript จะสร้างช่อง 16 ช่องที่นี่ -->
            </div>
            
            <!-- Progress Bar -->
            <div class="px-6 pb-4">
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                  <div id="progressBar" class="bg-wuerth-red h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
            </div>
        </div>

    </main>

    <!-- Bottom Action Buttons (Fixed) -->
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 pb-safe flex gap-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-20">
        <button onclick="handleScanQR()" class="flex-1 bg-wuerth-red hover:bg-wuerth-dark text-white font-semibold py-3 px-4 rounded-xl shadow-md transition-colors flex items-center justify-center gap-2">
            <i class="fa-solid fa-qrcode text-lg"></i>
            <span>สแกน QR Code</span>
        </button>
        <button onclick="handleManualPin()" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-3 px-4 rounded-xl shadow-sm transition-colors border border-gray-300 flex items-center justify-center gap-2">
            <i class="fa-solid fa-keyboard text-lg text-gray-600"></i>
            <span>กรอกรหัส</span>
        </button>
    </div>

    <!-- Script Logic -->
    <script>
        // ==========================================================
        // ตั้งค่าตัวแปรสำคัญ (Configuration)
        // ==========================================================
        const LIFF_ID = "2009175418-UODHvYrB"; // LIFF ID จากผู้ใช้
        
        // **สำคัญ**: นำลิงก์ Web App URL (ที่ได้จากการ Deploy กด New Deployment ล่าสุด) มาวางที่นี่
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwYOUR_APP_SCRIPT_ID_HERE/exec"; 
        
        const MAX_POINTS = 16;
        let currentUser = null;
        let currentPoints = 0;

        document.addEventListener("DOMContentLoaded", () => {
            renderEmptyStamps();
            initializeLiff();
        });

        function renderEmptyStamps() {
            const grid = document.getElementById('stampGrid');
            grid.innerHTML = '';
            for (let i = 1; i <= MAX_POINTS; i++) {
                grid.innerHTML += `
                    <div class="stamp-slot" id="slot-${i}">
                        <div class="text-gray-300 text-xs font-semibold absolute">${i}</div>
                        <i class="fa-solid fa-check-circle stamp-icon" id="icon-${i}"></i>
                    </div>
                `;
            }
        }

        async function initializeLiff() {
            try {
                document.getElementById('loadingText').innerText = "กำลังเชื่อมต่อ LINE...";
                await liff.init({ liffId: LIFF_ID });
                
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    currentUser = profile;
                    
                    document.getElementById('userName').innerText = profile.displayName;
                    if(profile.pictureUrl) {
                        document.getElementById('userProfilePic').src = profile.pictureUrl;
                    }

                    // ใช้ fetch เรียกไปยัง GAS Backend
                    fetchUserDataFromAPI();
                } else {
                    liff.login();
                }
            } catch (err) {
                console.error("LIFF Init Error:", err);
                hideLoading();
                Swal.fire({
                    title: 'โหมดจำลอง (Mock Mode)',
                    text: 'ไม่ได้รันผ่านระบบ LINE หรือเชื่อมต่อ LIFF ไม่สำเร็จ',
                    icon: 'info',
                    confirmButtonColor: '#CC0000'
                });
                setupMockUser();
            }
        }

        function setupMockUser() {
            currentUser = {
                userId: "mock_user_123",
                displayName: "Guest User",
                pictureUrl: "https://via.placeholder.com/150"
            };
            document.getElementById('userName').innerText = currentUser.displayName;
            fetchUserDataFromAPI();
        }

        // ==========================================================
        // การเชื่อมต่อ API แบบใหม่ ด้วยการใช้ Fetch() ทะลวง Iframe
        // ==========================================================
        async function fetchUserDataFromAPI() {
            document.getElementById('loadingText').innerText = "กำลังดึงข้อมูลสะสมแต้ม...";
            
            // เช็คว่าได้ใส่ URL ของระบบหลังบ้านหรือยัง
            if (GAS_API_URL.includes("YOUR_APP_SCRIPT_ID_HERE")) {
                console.warn("ยังไม่ได้ตั้งค่า GAS_API_URL - ทำงานในโหมดจำลอง");
                hideLoading();
                updateStampsUI(3, false);
                return;
            }

            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', 
                        // ใช้ text/plain เลี่ยงปัญหา CORS Preflight ของ GAS
                    },
                    body: JSON.stringify({
                        action: 'getUserData',
                        userId: currentUser.userId,
                        displayName: currentUser.displayName,
                        pictureUrl: currentUser.pictureUrl
                    }),
                    redirect: "follow" // สำคัญมากสำหรับ GAS เพื่อตาม Redirect (302) ไปรับข้อมูลจริง
                });

                const result = await response.json();
                hideLoading();

                if(result.success) {
                    updateStampsUI(result.points, false);
                } else {
                    Swal.fire('เกิดข้อผิดพลาด', result.error || 'ไม่สามารถดึงข้อมูลได้', 'error');
                }

            } catch (e) {
                hideLoading();
                console.error("Fetch API Error:", e);
                Swal.fire('การเชื่อมต่อล้มเหลว', 'เกิดข้อผิดพลาดในการติดต่อฐานข้อมูล (กรุณาเช็ค URL ฝั่ง GAS)', 'error');
            }
        }

        function updateStampsUI(points, animateLast = false) {
            currentPoints = points;
            
            document.getElementById('pointsText').innerText = points;
            const progressPercent = (points / MAX_POINTS) * 100;
            document.getElementById('progressBar').style.width = `${progressPercent}%`;

            for (let i = 1; i <= MAX_POINTS; i++) {
                const slot = document.getElementById(`slot-${i}`);
                const icon = document.getElementById(`icon-${i}`);
                
                if (i <= points) {
                    slot.classList.add('stamp-active');
                    slot.querySelector('div.absolute').style.display = 'none';
                    
                    if (animateLast && i === points) {
                        icon.classList.add('stamp-appear');
                    } else {
                        icon.style.opacity = '1';
                        icon.style.transform = 'scale(1)';
                    }
                }
            }

            if (animateLast && points >= MAX_POINTS) {
                setTimeout(() => {
                    fireConfetti();
                    Swal.fire({
                        title: 'ยินดีด้วย!',
                        text: 'คุณสะสมแต้มครบ 16 ดวงแล้ว',
                        icon: 'success',
                        confirmButtonColor: '#CC0000',
                        confirmButtonText: 'รับรางวัล'
                    });
                }, 800);
            }
        }

        function handleScanQR() {
            if (!liff.isInClient()) {
                Swal.fire('ฟีเจอร์นี้ใช้ได้เฉพาะในแอป LINE', 'กรุณาเปิดแอปนี้ผ่าน LINE เพื่อใช้งานกล้อง', 'warning');
                return;
            }
            
            liff.scanCodeV2().then(result => {
                if (result && result.value) {
                    processPinSubmission(result.value);
                }
            }).catch(err => {
                console.error("Scan Error:", err);
            });
        }

        function handleManualPin() {
            Swal.fire({
                title: 'กรอกรหัส PIN',
                input: 'text',
                inputAttributes: { autocapitalize: 'off' },
                showCancelButton: true,
                confirmButtonText: 'ตกลง',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#CC0000',
                showLoaderOnConfirm: true,
                preConfirm: (pin) => {
                    if (!pin || pin.trim() === '') {
                        Swal.showValidationMessage('กรุณากรอกรหัส PIN');
                    }
                    return pin;
                },
                allowOutsideClick: () => !Swal.isLoading()
            }).then((result) => {
                if (result.isConfirmed) {
                    processPinSubmission(result.value);
                }
            });
        }

        async function processPinSubmission(pin) {
            Swal.fire({
                title: 'กำลังตรวจสอบ...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            if (GAS_API_URL.includes("YOUR_APP_SCRIPT_ID_HERE")) {
                setTimeout(() => {
                    Swal.close();
                    Swal.fire('สำเร็จ (Mock Mode)', 'รับรหัสจำลองเรียบร้อย', 'success');
                    updateStampsUI(currentPoints + 1, true);
                }, 1000);
                return;
            }

            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8'
                    },
                    body: JSON.stringify({
                        action: 'submitPin',
                        userId: currentUser.userId,
                        pin: pin
                    }),
                    redirect: "follow" // สำคัญมากสำหรับ GAS
                });

                const result = await response.json();
                
                if (result.success) {
                    Swal.close();
                    updateStampsUI(result.newPoints, true);
                } else {
                    Swal.fire('ไม่สำเร็จ', result.message, 'error');
                }

            } catch(e) {
                console.error("API Error:", e);
                Swal.fire('ข้อผิดพลาด', 'ระบบทำงานผิดพลาด ไม่สามารถติดต่อ Server ได้', 'error');
            }
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if(overlay) overlay.style.display = 'none';
        }

        function fireConfetti() {
            var duration = 3 * 1000;
            var animationEnd = Date.now() + duration;
            var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 100 };

            function randomInRange(min, max) { return Math.random() * (max - min) + min; }

            var interval = setInterval(function() {
                var timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) { return clearInterval(interval); }
                var particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }
    </script>
</body>
</html>
